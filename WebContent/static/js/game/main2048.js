var board=new Array();var score=0;var hasConflicted=new Array();var winOnce=false;$(document).ready(function(){prepareForMobile();newgame();hideDialog()});function hideDialog(){$(".dialog-success").css("display","none");$(".dialog-fail").css("display","none")}function prepareForMobile(){if(isPC()){gridContainerWidth=500;cellSpace=20;cellSideLength=100}$("#grid-container").css("width",gridContainerWidth-2*cellSpace+40);$("#grid-container").css("height",gridContainerWidth-2*cellSpace+40);$("#grid-container").css("padding",cellSpace);$("#grid-container").css("border-radius",0.02*gridContainerWidth);if(documentHeight*3/documentWidth>5){$("header").css("margin-top",cellSideLength)}$(".grid-cell").css("width",cellSideLength);$(".grid-cell").css("height",cellSideLength);$(".grid-cell").css("border-radius",0.02*cellSideLength)}function newgame(){init();generateOneNumber();generateOneNumber();resetSocre()}function again(){newgame();hideDialog();resetSocre()}function conti(){hideDialog()}function init(){for(var b=0;b<4;b++){for(var a=0;a<4;a++){var c=$("#grid-cell-"+b+"-"+a);c.css("top",getPosTop(b,a));c.css("left",getPosLeft(b,a))}}for(var b=0;b<4;b++){board[b]=new Array();hasConflicted[b]=new Array();for(var a=0;a<4;a++){board[b][a]=0;hasConflicted[b][a]=false}}winOnce=false;score=0;updateBoardView()}function updateBoardView(){$(".number-cell").remove();for(var c=0;c<4;c++){for(var b=0;b<4;b++){$("#grid-container").append('<div class = "number-cell" id = "number-cell-'+c+"-"+b+'"></div>');var a=$("#number-cell-"+c+"-"+b);if(board[c][b]==0){a.css("width","0px");a.css("height","0px");a.css("top",getPosTop(c,b)+cellSideLength/2);a.css("left",getPosLeft(c,b)+cellSideLength/2)}else{a.css("width",cellSideLength+"px");a.css("height",cellSideLength+"px");a.css("top",getPosTop(c,b));a.css("left",getPosLeft(c,b));a.css("background-color",getNumberCellBgColor(board[c][b]));a.css("color",getNumberCellFontColor(board[c][b]));a.css("font-size",getNumberCellFontSize(board[c][b]));a.text(board[c][b])}hasConflicted[c][b]=false}}$(".number-cell").css("line-height",cellSideLength+"px")}function generateOneNumber(){if(nospace(board)){return false}var c=parseInt(Math.floor(Math.random()*4));var b=parseInt(Math.floor(Math.random()*4));while(true){if(board[c][b]==0){break}var c=parseInt(Math.floor(Math.random()*4));var b=parseInt(Math.floor(Math.random()*4))}var a=Math.random()<0.5?2:4;board[c][b]=a;showNumberWithAnimation(c,b,a);return true}$(document).keydown(function(a){switch(a.keyCode){case 37:a.preventDefault();if(moveLeft()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}break;case 38:a.preventDefault();if(moveUp()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}break;case 39:a.preventDefault();if(moveRight()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}break;case 40:a.preventDefault();if(moveDown()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}break;default:return}});document.addEventListener("touchstart",function(a){startx=a.touches[0].pageX;starty=a.touches[0].pageY});document.addEventListener("touchmove",function(a){a.preventDefault()});document.addEventListener("touchend",function(c){endx=c.changedTouches[0].pageX;endy=c.changedTouches[0].pageY;var b=endx-startx;var a=endy-starty;if(Math.abs(b)<0.2*documentWidth&&Math.abs(a)<0.2*documentWidth){return}if(Math.abs(b)>=Math.abs(a)){if(b>0){if(moveRight()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}}else{if(moveLeft()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}}}else{if(a>0){if(moveDown()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}}else{if(moveUp()){setTimeout("generateOneNumber()",210);setTimeout("isGameover()",300);setTimeout("isWin()",300)}}}});function isGameover(){if(nospace(board)&&nomove(board)){gameover()}}function isWin(){for(var a=0;a<4;a++){for(var b=1;b<4;b++){if(board[b][a]==2048){if(winOnce==false){win();winOnce=true}}}}return false}function win(){$(".dialog-success").css("display","block")}function gameover(){$(".dialog-fail").css("display","block")}function moveUp(){if(!canMoveUp(board)){return false}for(var b=0;b<4;b++){for(var c=1;c<4;c++){if(board[c][b]!=0){for(var a=0;a<c;a++){if(board[a][b]==0&&noUpBlock(c,b,a,board)){showMoveAnimation(c,b,a,b);board[a][b]=board[c][b];board[c][b]=0;continue}else{if(board[a][b]==board[c][b]&&noUpBlock(c,b,a,board)&&!hasConflicted[a][b]){showMoveAnimation(c,b,a,b);board[a][b]+=board[c][b];board[c][b]=0;score+=board[a][b];setTimeout("changeScore(score)",310);hasConflicted[a][b]=true;continue}}}}}}setTimeout("updateBoardView()",200);return true}function moveDown(){if(!canMoveDown(board)){return false}for(var b=0;b<4;b++){for(var c=2;c>=0;c--){if(board[c][b]!=0){for(var a=3;a>c;a--){if(board[a][b]==0&&noDownBlock(c,b,a,board)){showMoveAnimation(c,b,a,b);board[a][b]=board[c][b];board[c][b]=0;continue}else{if(board[a][b]==board[c][b]&&noDownBlock(c,b,a,board)&&!hasConflicted[a][b]){showMoveAnimation(c,b,a,b);board[a][b]+=board[c][b];board[c][b]=0;score+=board[a][b];setTimeout("changeScore(score)",310);hasConflicted[a][b]=true;continue}}}}}}setTimeout("updateBoardView()",200);return true}function moveRight(){if(!canMoveRight(board)){return false}for(var c=0;c<4;c++){for(var b=2;b>=0;b--){if(board[c][b]!=0){for(var a=3;a>b;a--){if(board[c][a]==0&&noRightBlock(c,b,a,board)){showMoveAnimation(c,b,c,a);board[c][a]=board[c][b];board[c][b]=0;continue}else{if(board[c][a]==board[c][b]&&noRightBlock(c,b,a,board)&&!hasConflicted[c][a]){showMoveAnimation(c,b,c,a);board[c][a]+=board[c][b];board[c][b]=0;score+=board[c][a];setTimeout("changeScore(score)",310);hasConflicted[c][a]=true;continue}}}}}}setTimeout("updateBoardView()",200);return true}function moveLeft(){if(!canMoveLeft(board)){return false}for(var c=0;c<4;c++){for(var b=1;b<4;b++){if(board[c][b]!=0){for(var a=0;a<b;a++){if(board[c][a]==0&&noLeftBlock(c,b,a,board)){showMoveAnimation(c,b,c,a);board[c][a]=board[c][b];board[c][b]=0;continue}else{if(board[c][a]==board[c][b]&&noLeftBlock(c,b,a,board)&&!hasConflicted[c][a]){showMoveAnimation(c,b,c,a);board[c][a]+=board[c][b];board[c][b]=0;score+=board[c][a];setTimeout("changeScore(score)",310);hasConflicted[c][a]=true;continue}}}}}}setTimeout("updateBoardView()",200);return true};